# PhotoGeoView Tauri移行 実装計画書

**作成日**: 2025-12-29
**バージョン**: 1.0
**対象**: PhotoGeoView v3.0.0 (Tauri版)

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [技術スタックの選択理由](#2-技術スタックの選択理由)
3. [アーキテクチャ設計](#3-アーキテクチャ設計)
4. [機能要件](#4-機能要件)
5. [UI導線設計](#5-ui導線設計)
6. [技術的課題と対応策](#6-技術的課題と対応策)
7. [移行戦略](#7-移行戦略)
8. [品質保証](#8-品質保証)

---

## 1. プロジェクト概要

### 1.1 移行の背景

PhotoGeoViewは、写真のEXIF位置情報を地図上に可視化するデスクトップアプリケーションです。現在、Electron + React + TypeScriptで実装されたv2.2.1が存在しますが、以下の課題に直面しています：

- **electron-builderの不安定さ**: Windows向けインストーラーの生成が失敗するケースが多発
- **ビルドツールの信頼性**: 本番環境へのデプロイに支障をきたす可能性

### 1.2 移行の目的

1. **ビルド環境の安定化**: Tauriの安定したビルドシステムを採用
2. **技術的な実験と学習**: Rust + Tauriの実践的習得
3. **パフォーマンス向上**: ネイティブバイナリによる高速化
4. **バイナリサイズの削減**: 配布パッケージの軽量化

### 1.3 C#/.NET版との位置づけ

- **C#/.NET10/WinUI3版**: Windows専用の本命実装（高機能版）
- **Tauri版**: クロスプラットフォーム対応の軽量版
- **関係性**: Tauri版は実験的プロジェクトとして、失敗しても実用上の問題はない

この位置づけにより、Tauri版では技術的な挑戦やリスクのある実装を積極的に試すことができます。

---

## 2. 技術スタックの選択理由

### 2.1 バックエンド: Tauri v2 + Rust

#### Tauri v2を選択する理由

**利点**:
1. **安定したビルドシステム**: electron-builderの課題を解決
2. **軽量なバイナリ**: 約10MB（Electron: 約100MB）
3. **高速起動**: ネイティブバイナリによる高速化
4. **セキュリティ**: Rustの型安全性とメモリ安全性
5. **システムリソース**: OS標準のWebViewを使用し、メモリ消費が少ない

**欠点（受け入れ可能）**:
1. **Electronほど成熟していない**: → 実験プロジェクトなので問題なし
2. **Node.jsエコシステムが使えない**: → Rustで再実装が必要だが、学習機会として捉える

#### Rustバックエンドの利点

1. **型安全性**: コンパイル時のエラー検出
2. **パフォーマンス**: C++並みの高速性
3. **並行処理**: 安全な並行処理が容易
4. **エラーハンドリング**: `Result<T, E>`による明示的なエラー処理
5. **学習価値**: モダンなシステムプログラミング言語の習得

### 2.2 フロントエンド

#### React 19

**選択理由**:
- Electron版の資産を最大限流用可能
- 最新のReact Compiler対応でパフォーマンス向上
- 既存のコンポーネントをほぼそのまま使用可能

#### TypeScript 5.7+

**選択理由**:
- Electron版との一貫性
- 型安全性による開発効率向上
- AI支援開発との相性が良い

#### Vite 6

**選択理由**:
- Tauri公式推奨ビルドツール
- 高速なHMR（Hot Module Replacement）
- Electron版と同じビルドツール（学習コストゼロ）

#### TailwindCSS v4

**選択理由**:
- Electron版と同じスタイリング手法
- 既存のUIコンポーネントを流用可能
- 高速な開発サイクル

### 2.3 主要ライブラリ

#### UI コンポーネント

- **shadcn/ui + Radix UI**: Electron版と同じコンポーネントライブラリ
  - 理由: 既存資産の流用、アクセシビリティ対応

#### 状態管理

- **Zustand**: 軽量でシンプルな状態管理
  - 理由: Electron版と同じ、Tauriとの相性が良い

#### 地図表示

- **React Leaflet 5**: オープンソースの地図ライブラリ
  - 理由: Electron版と同じ、既存のマップコンポーネントを流用

#### データフェッチング

- **TanStack Query**: サーバー状態管理
  - 理由: Tauri Commandの呼び出しをキャッシュ・管理

#### 国際化

- **i18next + react-i18next**: 多言語対応
  - 理由: Electron版と同じ、既存の翻訳ファイルを流用

### 2.4 Rustクレート（主要）

#### 画像処理

- **image**: 画像の読み込み・リサイズ・変換
  - 理由: Rustの標準的な画像処理クレート
- **kamadak-exif**: EXIF情報の読み取り
  - 理由: Tauri公式ドキュメントでも推奨

#### ファイルシステム

- **tauri-plugin-fs**: ファイルシステムアクセス
  - 理由: Tauri公式プラグイン、セキュリティ対応済み
- **tauri-plugin-dialog**: ファイル選択ダイアログ
  - 理由: Tauri公式プラグイン

#### シリアライゼーション

- **serde**: JSON等のシリアライズ・デシリアライズ
  - 理由: Rustの標準的なシリアライゼーションライブラリ
- **serde_json**: JSON操作
  - 理由: フロントエンドとのデータ交換

#### エラーハンドリング

- **thiserror**: カスタムエラー型の定義
  - 理由: エラーハンドリングのベストプラクティス
- **anyhow**: エラー処理の簡略化
  - 理由: アプリケーション層でのエラー処理

---

## 3. アーキテクチャ設計

### 3.1 全体構成

```
┌─────────────────────────────────────┐
│         フロントエンド              │
│   (React + TypeScript + Vite)       │
│                                     │
│  ┌──────────┐  ┌──────────┐       │
│  │   UI     │  │  State   │       │
│  │Components│  │ (Zustand)│       │
│  └──────────┘  └──────────┘       │
│         │              │           │
│         └──────┬───────┘           │
│                │                   │
│         ┌──────▼──────┐            │
│         │ Tauri API   │            │
│         │ (Commands)  │            │
│         └──────────────┘           │
└───────────────┬─────────────────────┘
                │ IPC (JSON)
┌───────────────▼─────────────────────┐
│          バックエンド                │
│        (Rust + Tauri)               │
│                                     │
│  ┌──────────────────────────────┐  │
│  │      Tauri Commands          │  │
│  │  (ファイル操作、EXIF読取等)  │  │
│  └──────────────────────────────┘  │
│                │                   │
│  ┌─────────────▼──────────────┐   │
│  │     ビジネスロジック        │   │
│  │  ・EXIF解析               │   │
│  │  ・画像処理               │   │
│  │  ・ファイルシステム操作    │   │
│  └──────────────────────────────┘  │
│                │                   │
│  ┌─────────────▼──────────────┐   │
│  │     OS ネイティブAPI        │   │
│  │  ・ファイルシステム         │   │
│  │  ・システムダイアログ       │   │
│  └──────────────────────────────┘  │
└─────────────────────────────────────┘
```

### 3.2 ディレクトリ構造

```
PhotoGeoView/
├── src/                    # フロントエンドソース
│   ├── components/         # Reactコンポーネント
│   │   ├── map/           # 地図関連コンポーネント
│   │   ├── photo/         # 写真表示コンポーネント
│   │   ├── ui/            # shadcn/uiコンポーネント
│   │   └── layout/        # レイアウトコンポーネント
│   ├── hooks/             # カスタムフック
│   ├── stores/            # Zustand状態管理
│   ├── lib/               # ユーティリティ
│   ├── i18n/              # 国際化ファイル
│   ├── types/             # TypeScript型定義
│   ├── App.tsx            # ルートコンポーネント
│   └── main.tsx           # エントリーポイント
├── src-tauri/             # バックエンドソース (Rust)
│   ├── src/
│   │   ├── main.rs        # エントリーポイント
│   │   ├── commands/      # Tauri Commandsモジュール
│   │   │   ├── mod.rs
│   │   │   ├── file.rs    # ファイル操作
│   │   │   ├── exif.rs    # EXIF読取
│   │   │   └── image.rs   # 画像処理
│   │   ├── models/        # データモデル
│   │   ├── services/      # ビジネスロジック
│   │   └── utils/         # ユーティリティ
│   ├── Cargo.toml         # Rust依存関係
│   ├── tauri.conf.json    # Tauri設定
│   └── icons/             # アプリアイコン
├── public/                # 静的ファイル
├── docs/                  # ドキュメント
├── archive/               # アーカイブ
│   └── electron-version/  # 旧Electron版
├── package.json           # Node.js依存関係
├── tsconfig.json          # TypeScript設定
├── vite.config.ts         # Vite設定
├── tailwind.config.js     # TailwindCSS設定
└── README.md              # プロジェクト概要
```

### 3.3 データフロー

#### 写真読み込みフロー

```
[ユーザー] → [ファイル選択ボタン]
    → [Tauri Dialog API]
    → [ファイルパス取得]
    → [Tauri Command: read_photo_exif(path)]
    → [Rust: EXIF解析]
    → [返却: PhotoData { path, exif, thumbnail }]
    → [フロントエンド: Zustandに保存]
    → [地図にマーカー表示 + サムネイル一覧更新]
```

#### 画像表示フロー

```
[サムネイルクリック]
    → [Tauri Command: load_image(path)]
    → [Rust: 画像読み込み + リサイズ]
    → [返却: Base64エンコード画像]
    → [フロントエンド: 画像ビューアに表示]
```

### 3.4 IPC設計

#### Command定義例

**ファイル操作**:
- `select_photos()` → `Vec<String>` (選択されたファイルパスリスト)
- `read_photo_exif(path: String)` → `PhotoData`
- `load_image(path: String, max_width: u32)` → `String` (Base64)

**設定管理**:
- `get_settings()` → `AppSettings`
- `save_settings(settings: AppSettings)` → `Result<(), String>`

**エクスポート**:
- `export_to_csv(photos: Vec<PhotoData>, path: String)` → `Result<(), String>`

---

## 4. 機能要件

### 4.1 コア機能

#### 必須機能（MVP）

1. **写真ファイルの読み込み**
   - 対応形式: JPEG, PNG, TIFF, WebP
   - 複数ファイルの同時選択
   - ドラッグ&ドロップ対応

2. **EXIF位置情報の抽出**
   - GPS緯度・経度の読み取り
   - 撮影日時の読み取り
   - カメラ情報の読み取り

3. **地図表示**
   - OpenStreetMap / Google Maps / Satellite view
   - マーカー表示（写真位置）
   - マーカークリックで写真プレビュー

4. **写真一覧表示**
   - サムネイル一覧
   - 撮影日時でソート
   - クリックで拡大表示

5. **基本設定**
   - 言語切替（日本語/英語）
   - ダークモード/ライトモード
   - デフォルト地図タイル選択

#### 追加機能（Phase 2以降）

1. **フィルタリング**
   - 日付範囲指定
   - 位置範囲指定（地図上で選択）

2. **エクスポート**
   - CSV形式（写真パス、緯度、経度、日時）
   - KML形式（Google Earth用）

3. **編集機能**
   - EXIF位置情報の手動編集
   - マーカーのドラッグ移動

### 4.2 UI/UX要件

#### レイアウト

- **3ペイン構成**:
  - 左: 写真サムネイル一覧
  - 中央: 地図表示
  - 右: 写真詳細・EXIF情報

#### レスポンシブ対応

- 最小ウィンドウサイズ: 1024x768
- パネルのリサイズ可能
- レイアウトプリセット保存

#### パフォーマンス

- 1000枚の写真を10秒以内に読み込み
- 地図のスムーズなパン・ズーム（60fps）
- サムネイル表示の仮想スクロール

---

## 5. UI導線設計

### 5.1 起動から写真表示までの基本フロー

```
[アプリ起動]
    ↓
[メイン画面表示]
    ├─ 左パネル: 空の写真一覧
    ├─ 中央パネル: デフォルト地図（東京中心）
    └─ 右パネル: ウェルカムメッセージ
    ↓
[ユーザー操作: ファイルメニュー → "写真を開く"]
または
[ドラッグ&ドロップ]
    ↓
[ファイル選択ダイアログ表示]
    ↓
[ファイル選択 → OK]
    ↓
[ローディング表示]
    ↓
[EXIF読み取り処理（バックグラウンド）]
    ↓
[結果表示]
    ├─ 左パネル: サムネイル一覧
    ├─ 中央パネル: 地図にマーカー表示
    └─ 右パネル: 最初の写真の詳細
    ↓
[ユーザー操作: サムネイルクリック]
    ↓
[右パネル: 選択写真の拡大表示 + EXIF詳細]
[中央パネル: 該当マーカーにフォーカス]
```

### 5.2 メインメニュー構成

```
ファイル (File)
├─ 写真を開く (Ctrl+O)
├─ フォルダを開く (Ctrl+Shift+O)
├─ 最近開いたファイル
├─ ─────────
├─ エクスポート
│  ├─ CSV形式で保存
│  └─ KML形式で保存
├─ ─────────
└─ 終了 (Ctrl+Q)

表示 (View)
├─ サムネイル表示切替
├─ 地図タイル変更
│  ├─ OpenStreetMap
│  ├─ Google Maps
│  └─ Satellite
├─ ─────────
├─ レイアウトプリセット
│  ├─ デフォルト
│  ├─ 地図メイン
│  └─ 写真メイン
└─ ─────────
└─ フルスクリーン (F11)

ツール (Tools)
├─ 設定 (Ctrl+,)
└─ EXIF一括更新

ヘルプ (Help)
├─ ドキュメント
├─ GitHub Issuesを開く
├─ ─────────
└─ バージョン情報
```

### 5.3 コンテキストメニュー

**サムネイル右クリック**:
- 大きいプレビューを表示
- ファイルをエクスプローラーで開く
- EXIF情報をコピー
- 一覧から削除

**マーカー右クリック**:
- 写真を表示
- 位置をコピー
- Google Mapsで開く

### 5.4 キーボードショートカット

- `Ctrl+O`: 写真を開く
- `Ctrl+S`: エクスポート
- `F11`: フルスクリーン
- `←/→`: 前後の写真に移動
- `Delete`: 選択写真を一覧から削除
- `Ctrl+F`: 検索（日付・位置）

---

## 6. 技術的課題と対応策

### 6.1 sharpの代替（画像処理）

#### 課題
Electron版では`sharp`（Node.jsネイティブモジュール）を使用していたが、Tauriでは使用不可。

#### 対応策

**採用: `image`クレート**
- **理由**: Rustの標準的な画像処理ライブラリ、高速
- **機能**: リサイズ、フォーマット変換、サムネイル生成
- **実装方針**:
  ```rust
  use image::io::Reader as ImageReader;
  use image::imageops::FilterType;

  // サムネイル生成例
  let img = ImageReader::open(path)?.decode()?;
  let thumbnail = img.resize(200, 200, FilterType::Lanczos3);
  ```

**パフォーマンス比較**（予定）:
- ベンチマークテストでsharpと比較
- 許容範囲内であれば採用、問題があれば`libvips` FFIを検討

### 6.2 EXIF情報の読み取り

#### 採用: `kamadak-exif`クレート

- **理由**: Tauri公式ドキュメントでも推奨、十分な機能
- **対応フォーマット**: JPEG, TIFF
- **実装方針**:
  ```rust
  use exif::{Reader, In, Tag};

  let file = std::fs::File::open(path)?;
  let mut bufreader = std::io::BufReader::new(&file);
  let exifreader = Reader::new().read_from_container(&mut bufreader)?;

  // GPS情報取得
  let lat = exifreader.get_field(Tag::GPSLatitude, In::PRIMARY);
  let lon = exifreader.get_field(Tag::GPSLongitude, In::PRIMARY);
  ```

### 6.3 大量ファイルの処理

#### 課題
1000枚以上の写真を一度に読み込む際のパフォーマンス

#### 対応策

1. **並列処理**: `rayon`クレートで並列EXIF読み取り
   ```rust
   use rayon::prelude::*;

   let results: Vec<PhotoData> = file_paths
       .par_iter()
       .map(|path| read_exif(path))
       .collect();
   ```

2. **プログレスバー**: フロントエンドに進捗を通知
   - Tauri Event APIで進捗率を送信
   - UIに読み込み進捗を表示

3. **遅延ローディング**: サムネイルは必要に応じて生成
   - 初回はパスとEXIF情報のみ読み込み
   - スクロール時にサムネイルを生成

### 6.4 ファイルシステムセキュリティ

#### Tauriのセキュリティモデル

Tauriはデフォルトでファイルシステムアクセスを制限しています。

#### 対応策

1. **Scope設定**: `tauri.conf.json`で許可するディレクトリを指定
   ```json
   {
     "tauri": {
       "allowlist": {
         "fs": {
           "scope": ["$HOME/Pictures/**", "$DESKTOP/**"]
         }
       }
     }
   }
   ```

2. **ダイアログAPI使用**: ユーザーが明示的に選択したファイルのみアクセス
   - `tauri-plugin-dialog`で安全にファイル選択

### 6.5 クロスプラットフォーム対応

#### パス区切り文字の違い

- Windows: `\`
- macOS/Linux: `/`

#### 対応策

**`std::path::PathBuf`を使用**: Rustの標準ライブラリが自動的に適切な形式に変換

---

## 7. 移行戦略

### 7.1 段階的実装計画

#### Phase 1: 基盤構築（Week 1-2）

- [ ] Tauriプロジェクト初期化
- [ ] 基本的なUI構造（3ペインレイアウト）
- [ ] Tauri Command通信テスト
- [ ] ファイル選択ダイアログ実装

#### Phase 2: コア機能（Week 3-4）

- [ ] EXIF読み取り機能
- [ ] 地図表示（React Leaflet統合）
- [ ] サムネイル一覧表示
- [ ] 写真詳細表示

#### Phase 3: 既存資産の移植（Week 5-6）

- [ ] Electron版UIコンポーネント移植
- [ ] 国際化（i18n）対応
- [ ] ダークモード/ライトモード
- [ ] 設定画面

#### Phase 4: 高度な機能（Week 7-8）

- [ ] フィルタリング
- [ ] エクスポート（CSV/KML）
- [ ] パフォーマンス最適化
- [ ] エラーハンドリング改善

#### Phase 5: 仕上げ（Week 9-10）

- [ ] テスト（単体・E2E）
- [ ] ビルド設定最適化
- [ ] ドキュメント整備
- [ ] リリースノート作成

### 7.2 既存資産の流用方針

#### 流用可能（そのまま or 軽微な修正）

- ✅ Reactコンポーネント（UI層）
- ✅ TailwindCSSスタイル
- ✅ i18n翻訳ファイル
- ✅ 型定義（TypeScript）
- ✅ Zustand Stores（一部修正）

#### 再実装必要

- ❌ Electronメインプロセス → Rust Tauri Commands
- ❌ IPC通信 → Tauri Command呼び出し
- ❌ ファイルシステムアクセス → Rust実装
- ❌ 画像処理（sharp） → `image`クレート

---

## 8. 品質保証

### 8.1 テスト戦略

#### フロントエンド

- **単体テスト**: Vitest + React Testing Library
  - コンポーネントのロジックテスト
  - カスタムフックのテスト
  - カバレッジ目標: 70%以上

- **E2Eテスト**: Playwright（Tauri対応）
  - 写真読み込みフロー
  - 地図操作
  - エクスポート機能

#### バックエンド

- **Rustユニットテスト**: `cargo test`
  - EXIF読み取りロジック
  - 画像処理ロジック
  - エラーハンドリング
  - カバレッジ目標: 80%以上

- **統合テスト**: Tauri Command呼び出しテスト

### 8.2 CI/CD

#### GitHub Actions

```yaml
# .github/workflows/ci.yml
name: CI

on: [push, pull_request]

jobs:
  test-frontend:
    - pnpm test
    - pnpm typecheck
    - pnpm lint

  test-backend:
    - cargo test
    - cargo clippy
    - cargo fmt --check

  build:
    - pnpm tauri build
```

#### リリースフロー

1. バージョンタグ作成: `git tag v3.0.0`
2. GitHub Actions自動ビルド
3. Windows/macOS/Linux用バイナリ生成
4. GitHub Releasesに自動アップロード

### 8.3 パフォーマンス計測

#### ベンチマーク指標

- 100枚の写真読み込み: < 3秒
- 1000枚の写真読み込み: < 10秒
- サムネイル生成: < 100ms/枚
- 地図レンダリング: 60fps維持

#### 計測方法

- Rust: `criterion`クレートでベンチマーク
- フロントエンド: React DevTools Profiler

---

## 9. まとめ

### 9.1 主要な技術的決定

1. **Tauri v2 + Rust**: 安定したビルドシステムとパフォーマンス
2. **React 19 + TypeScript**: 既存資産の最大限の流用
3. **`image`クレート**: sharpの代替として採用
4. **段階的移行**: 10週間で完成を目指す

### 9.2 リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| `image`クレートのパフォーマンス不足 | 中 | ベンチマーク実施、必要に応じて`libvips` FFI検討 |
| Rustの学習コスト | 低 | 実験プロジェクトなので時間的余裕あり |
| Electron版との機能差分 | 低 | MVP機能に絞る、段階的に追加 |
| ビルドエラー | 低 | Tauri公式ドキュメントとコミュニティサポート活用 |

### 9.3 成功基準

- [ ] Windows/macOS/Linuxで安定してビルド可能
- [ ] 基本機能（写真読み込み、地図表示、EXIF表示）が動作
- [ ] Electron版と同等以上のパフォーマンス
- [ ] バイナリサイズ < 20MB
- [ ] Rustの基本的な習得

---

**以上**
