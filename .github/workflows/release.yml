name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v6

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows Installer
    needs: create-release
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 10.26.0

      - uses: actions/setup-node@v6
        with:
          node-version: "24.12.0"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build App
        run: pnpm build

      - name: Package (Windows)
        run: pnpm package --win --publish never

      - name: List output files
        run: dir dist
        shell: pwsh
        if: always()

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.exe
            dist/*.exe.blockmap
            dist/latest.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-unix:
    name: Build on ${{ matrix.os }}
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: mac
            artifact_ext: dmg
          - os: ubuntu-latest
            platform: linux
            artifact_ext: AppImage

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 10.26.0

      - uses: actions/setup-node@v6
        with:
          node-version: "24.12.0"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build App
        run: pnpm build

      - name: Package and Publish
        run: |
          if [ "$RUNNER_OS" == "macOS" ]; then
            pnpm package --mac --config.mac.identity=null --publish always
          else
            pnpm package --linux --config.mac.identity=null --publish always
          fi
        shell: bash
        env:
          DEBUG: electron-builder
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List output files
        run: ls -R dist || echo "dist directory not found"
        if: always()
