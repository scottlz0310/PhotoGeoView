# AIå“è³ªæ”¹å–„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™:
# - AIçµ±åˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å“è³ªè§£æž
# - AIè²¢çŒ®åº¦ã®æ¸¬å®šã¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
# - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å›žå¸°æ¤œå‡º
# - ã‚³ãƒ¼ãƒ‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
#
# ç”¨é€”: AIçµ±åˆã®å“è³ªä¿è¨¼ã¨ç¶™ç¶šçš„æ”¹å–„
# å®Ÿè¡Œ: æ¯Žæ—¥åˆå‰9æ™‚ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰ã€æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã€ãƒ—ãƒƒã‚·ãƒ¥æ™‚

name: AI Quality Improvement

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯Žæ—¥åˆå‰9æ™‚ã«å®Ÿè¡Œ
    - cron: '0 9 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  ai-analysis:
    name: AIå“è³ªè§£æž
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v5

    - name: Python ${{ env.PYTHON_VERSION }} ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install .[ci]

    - name: åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      run: |
        echo "åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
        pytest tests/ -v --cov=src --cov-report=xml --tb=short || echo "ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"

    - name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
      run: |
        echo "ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        flake8 src/ --max-line-length=88 --extend-ignore=E203,W503,F401,E402 || echo "ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã®å•é¡ŒãŒã‚ã‚Šã¾ã™"
        black --check --diff src/ || echo "Blackãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆãŒå¿…è¦ã§ã™"
        isort --check-only --diff src/ || echo "ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚½ãƒ¼ãƒˆãŒå¿…è¦ã§ã™"

    - name: AIè§£æžãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè¡Œ
      run: |
        echo "AIè§£æžãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè¡Œä¸­..."
        python tools/github_actions_ai_analyzer_enhanced.py

    - name: è§£æžçµæžœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ai-analysis-results
        path: |
          reports/enhanced_ai_analysis_report_*.md
          reports/ci_report_*.json
          coverage.xml

  quality-improvement:
    name: å“è³ªæ”¹å–„ææ¡ˆ
    runs-on: ubuntu-latest
    needs: ai-analysis
    if: always()
    timeout-minutes: 15

    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v5

    - name: è§£æžçµæžœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v4
      with:
        name: ai-analysis-results
        path: ./analysis-results

    - name: å“è³ªæ”¹å–„ææ¡ˆã‚’ç”Ÿæˆ
      run: |
        echo "å“è³ªæ”¹å–„ææ¡ˆã‚’ç”Ÿæˆä¸­..."

        # æœ€æ–°ã®è§£æžãƒ¬ãƒãƒ¼ãƒˆã‚’æ¤œç´¢
        LATEST_REPORT=$(ls -t analysis-results/enhanced_ai_analysis_report_*.md 2>/dev/null | head -1)

        if [ -n "$LATEST_REPORT" ]; then
          echo "## ðŸ¤– AIå“è³ªæ”¹å–„ææ¡ˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š è§£æžçµæžœã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          cat "$LATEST_REPORT" >> $GITHUB_STEP_SUMMARY
        else
          echo "è§£æžãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
        fi

    - name: æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ææ¡ˆ
      run: |
        echo "### ðŸš€ æŽ¨å¥¨æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **ãƒ†ã‚¹ãƒˆå“è³ªå‘ä¸Š**: å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®è‡ªå‹•ä¿®æ­£" >> $GITHUB_STEP_SUMMARY
        echo "2. **ã‚³ãƒ¼ãƒ‰å“è³ªæ”¹å–„**: ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã®è‡ªå‹•ä¿®æ­£" >> $GITHUB_STEP_SUMMARY
        echo "3. **ä¾å­˜é–¢ä¿‚æœ€é©åŒ–**: å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è‡ªå‹•æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        echo "4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–**: ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®è‡ªå‹•ç‰¹å®š" >> $GITHUB_STEP_SUMMARY
        echo "5. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**: è„†å¼±æ€§ã®è‡ªå‹•æ¤œå‡ºã¨ä¿®æ­£" >> $GITHUB_STEP_SUMMARY

  auto-fix:
    name: è‡ªå‹•ä¿®æ­£å®Ÿè¡Œ
    runs-on: ubuntu-latest
    needs: [ai-analysis, quality-improvement]
    if: github.event_name == 'workflow_dispatch' && always()
    timeout-minutes: 20

    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Python ${{ env.PYTHON_VERSION }} ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install .[ci]

    - name: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã®è‡ªå‹•ä¿®æ­£
      run: |
        echo "ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚’è‡ªå‹•ä¿®æ­£ä¸­..."
        black src/ --line-length=88
        isort src/

    - name: ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆ
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        if git diff --quiet; then
          echo "ä¿®æ­£ã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
        else
          git add .
          git commit -m "ðŸ¤– AIå“è³ªæ”¹å–„: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã®è‡ªå‹•ä¿®æ­£"
          git push
        fi

  quality-report:
    name: å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    runs-on: ubuntu-latest
    needs: [ai-analysis, quality-improvement]
    if: always()
    timeout-minutes: 10

    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v5

    - name: è§£æžçµæžœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v4
      with:
        name: ai-analysis-results
        path: ./analysis-results

    - name: å“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
      run: |
        echo "å“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."

        # ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        mkdir -p quality-reports

        # æœ€æ–°ã®è§£æžãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼
        LATEST_REPORT=$(ls -t analysis-results/enhanced_ai_analysis_report_*.md 2>/dev/null | head -1)
        if [ -n "$LATEST_REPORT" ]; then
          cp "$LATEST_REPORT" quality-reports/latest_quality_report.md
        fi

        # å“è³ªã‚µãƒžãƒªãƒ¼ã‚’ç”Ÿæˆ
        cat > quality-reports/quality_summary.md << EOF
        # å“è³ªã‚µãƒžãƒªãƒ¼

        ç”Ÿæˆæ—¥æ™‚: $(date)

        ## å®Ÿè¡Œçµæžœ
        - AIè§£æž: ${{ needs.ai-analysis.result }}
        - å“è³ªæ”¹å–„ææ¡ˆ: ${{ needs.quality-improvement.result }}
        - è‡ªå‹•ä¿®æ­£: ${{ needs.auto-fix.result }}

        ## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
        1. è§£æžçµæžœã‚’ç¢ºèª
        2. æ”¹å–„ææ¡ˆã‚’å®Ÿè£…
        3. å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç›£è¦–
        EOF

    - name: å“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: quality-reports
        path: quality-reports/
