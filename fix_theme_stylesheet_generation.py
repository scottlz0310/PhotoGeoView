#!/usr/bin/env python3
"""
„ÉÜ„Éº„Éû„Çπ„Çø„Ç§„É´„Ç∑„Éº„ÉàÁîüÊàê„ÅÆ‰øÆÊ≠£

„ÉÜ„Éº„ÉûË®≠ÂÆöÊôÇ„Å´Ëâ≤„ÅåÊ≠£„Åó„ÅèÂ§âÂåñ„Åó„Å™„ÅÑÂïèÈ°å„Çí‰øÆÊ≠£„Åó„Åæ„Åô„ÄÇ
- „Çπ„Çø„Ç§„É´„Ç∑„Éº„ÉàÁîüÊàê„ÅÆÊîπÂñÑ
- „ÉÜ„Éº„ÉûÈÅ©Áî®„ÅÆÁ¢∫ÂÆüÊÄßÂêë‰∏ä
- „Éá„Éê„ÉÉ„Ç∞Ê©üËÉΩ„ÅÆËøΩÂä†

Author: Kiro AI Integration System
"""

import logging
from pathlib import Path
from typing import Dict, Any, List

def fix_theme_manager_stylesheet_generation():
    """„ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆ„Çπ„Çø„Ç§„É´„Ç∑„Éº„ÉàÁîüÊàê„Çí‰øÆÊ≠£"""

    theme_manager_path = Path("src/integration/ui/theme_manager.py")

    if not theme_manager_path.exists():
        print(f"‚ùå „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: {theme_manager_path}")
        return False

    print(f"üìù „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆ„Çπ„Çø„Ç§„É´„Ç∑„Éº„ÉàÁîüÊàê„Çí‰øÆÊ≠£‰∏≠...")

    with open(theme_manager_path, 'r', encoding='utf-8') as f:
        content = f.read()

    # 1. _apply_color_scheme „É°„ÇΩ„ÉÉ„Éâ„ÅÆÊîπÂñÑ
    old_apply_color_scheme = '''    def _apply_color_scheme(self, color_scheme: Dict[str, str]) -> bool:
        """„Ç´„É©„Éº„Çπ„Ç≠„Éº„É†„ÇíUI„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å´ÈÅ©Áî®"""
        try:
            if not color_scheme:
                return True

            # „Ç´„É©„Éº„Çπ„Ç≠„Éº„É†„Å´Âü∫„Å•„ÅÑ„Å¶„Çπ„Çø„Ç§„É´„Ç∑„Éº„Éà„ÇíÁîüÊàê
            additional_styles: List[str] = []

            # ËÉåÊôØËâ≤„ÅÆÈÅ©Áî®
            if 'background' in color_scheme:
                bg_color = color_scheme['background']
                additional_styles.append(
                    f"QWidget {{ background-color: {bg_color}; }}"
                )

            # ÂâçÊôØËâ≤Ôºà„ÉÜ„Ç≠„Çπ„ÉàÔºâ„ÅÆÈÅ©Áî®
reground' in color_scheme:
                fg_color = color_scheme['foreground']
                additional_styles.append(
                    f"QWidget {{ color: {fg_color}; }}"
                )

            # „Éó„É©„Ç§„Éû„É™„Ç´„É©„Éº„ÅÆÈÅ©Áî®
            if 'primary' in color_scheme:
                primary_color = color_scheme['primary']
                hover_color = color_scheme.get('primary_hover', primary_color)
                button_style = (
                    f"QPushButton {{ "
                    f"background-color: {primary_color}; "
                    f"color: white; "
                    f"border: none; "
                    f"padding: 8px 16px; "
                    f"border-radius: 4px; "
                    f"}} "
                    f"QPushButton:hover {{ "
                    f"background-color: {hover_color}; "
                    f"}}"
                )
                additional_styles.append(button_style)

            # „Çª„Ç´„É≥„ÉÄ„É™„Ç´„É©„Éº„ÅÆÈÅ©Áî®
            if 'secondary' in color_scheme:
                secondary_color = color_scheme['secondary']
                label_style = (
                    f"QLabel {{ color: {secondary_color}; }}"
                )
                additional_styles.append(label_style)

            # ÁîüÊàê„Åï„Çå„Åü„Çπ„Çø„Ç§„É´„Ç∑„Éº„Éà„ÇíÈÅ©Áî®
            if additional_styles:
                combined_styles = "\\n".join(additional_styles)
                return self._apply_style_sheet(combined_styles)

            return True

        except Exception as e:
            self.logger_system.error(f"Failed to apply color scheme: {e}")
            return False'''

    new_apply_color_scheme = '''    def _apply_color_scheme(self, color_scheme: Dict[str, str]) -> bool:
        """„Ç´„É©„Éº„Çπ„Ç≠„Éº„É†„ÇíUI„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å´ÈÅ©Áî®ÔºàÊîπÂñÑÁâàÔºâ"""
        try:
            if not color_scheme:
                self.logger_system.warning("Color scheme is empty, generating default styles")
                # „Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç´„É©„Éº„Çπ„Ç≠„Éº„É†„Çí‰ΩøÁî®
                color_scheme = self._get_default_color_scheme()

            self.logger_system.info(f"Applying color scheme: {color_scheme}")

            # „Ç´„É©„Éº„Çπ„Ç≠„Éº„É†„Å´Âü∫„Å•„ÅÑ„Å¶„Çπ„Çø„Ç§„É´„Ç∑„Éº„Éà„ÇíÁîüÊàê
            stylesheet_parts: List[str] = []

            # 1. „É°„Ç§„É≥„Ç¶„Ç£„É≥„Éâ„Ç¶„Å®QWidget„ÅÆÂü∫Êú¨„Çπ„Çø„Ç§„É´
            if 'background' in color_scheme and 'foreground' in color_scheme:
                bg_color = color_scheme['background']
                fg_color = color_scheme['foreground']

                main_style = f"""
                QMainWindow {{
                    background-color: {bg_color};
                    color: {fg_color};
                }}

                QWidget {{
                    background-color: {bg_color};
                    color: {fg_color};
                }}

                QFrame {{
                    background-color: {bg_color};
                    color: {fg_color};
                }}
                """
                stylesheet_parts.append(main_style)

            # 2. „Éú„Çø„É≥„Çπ„Çø„Ç§„É´
            if 'primary' in color_scheme:
                primary_color = color_scheme['primary']
                hover_color = color_scheme.get('hover', self._darken_color(primary_color))
                button_text_color = color_scheme.get('button_text', '#ffffff')

                button_style = f"""
                QPushButton {{
                    background-color: {primary_color};
                    color: {button_text_color};
                    border: 1px solid {primary_color};
                    padding: 6px 12px;
                    border-radius: 4px;
                    font-weight: bold;
                }}

                QPushButton:hover {{
                    background-color: {hover_color};
                    border-color: {hover_color};
                }}

                QPushButton:pressed {{
                    background-color: {self._darken_color(primary_color, 0.2)};
                }}

                QPushButton:disabled {{
                    background-color: {color_scheme.get('disabled', '#cccccc')};
                    color: #666666;
                }}
                """
                stylesheet_parts.append(button_style)

            # 3. „É©„Éô„É´„Å®„ÉÜ„Ç≠„Çπ„Éà„Çπ„Çø„Ç§„É´
            if 'foreground' in color_scheme:
                fg_color = color_scheme['foreground']
                secondary_color = color_scheme.get('secondary', fg_color)

                text_style = f"""
                QLabel {{
                    color: {fg_color};
                    background-color: transparent;
                }}

                QTextEdit {{
                    background-color: {color_scheme.get('input_background', color_scheme.get('background', '#ffffff'))};
                    color: {fg_color};
                    border: 1px solid {color_scheme.get('border', '#cccccc')};
                    border-radius: 3px;
                    padding: 4px;
                }}

                QLineEdit {{
                    background-color: {color_scheme.get('input_background', color_scheme.get('background', '#ffffff'))};
                    color: {fg_color};
                    border: 1px solid {color_scheme.get('border', '#cccccc')};
                    border-radius: 3px;
                    padding: 4px;
                }}
                """
                stylesheet_parts.append(text_style)

            # 4. „É°„Éã„É•„Éº„Å®„ÉÑ„Éº„É´„Éê„Éº„Çπ„Çø„Ç§„É´
            if 'background' in color_scheme and 'foreground' in color_scheme:
                bg_color = color_scheme['background']
                fg_color = color_scheme['foreground']
                selected_color = color_scheme.get('selected', color_scheme.get('primary', '#0078d4'))

                menu_style = f"""
                QMenuBar {{
                    background-color: {bg_color};
                    color: {fg_color};
                    border-bottom: 1px solid {color_scheme.get('border', '#cccccc')};
                }}

                QMenuBar::item {{
                    background-color: transparent;
                    padding: 4px 8px;
                }}

                QMenuBar::item:selected {{
                    background-color: {selected_color};
                    color: white;
                }}

                QMenu {{
                    background-color: {bg_color};
                    color: {fg_color};
                    border: 1px solid {color_scheme.get('border', '#cccccc')};
                }}

                QMenu::item:selected {{
                    background-color: {selected_color};
                    color: white;
                }}

                QToolBar {{
                    background-color: {bg_color};
                    color: {fg_color};
                    border: none;
                    spacing: 2px;
                }}
                """
                stylesheet_parts.append(menu_style)

            # 5. „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„Å®„Åù„ÅÆ‰ªñ„ÅÆ„Ç≥„É≥„Éà„É≠„Éº„É´
            if 'background' in color_scheme:
                bg_color = color_scheme['background']
                border_color = color_scheme.get('border', '#cccccc')

                control_style = f"""
                QScrollBar:vertical {{
                    background-color: {bg_color};
                    width: 12px;
                    border: none;
                }}

                QScrollBar::handle:vertical {{
                    background-color: {border_color};
                    border-radius: 6px;
                    min-height: 20px;
                }}

                QScrollBar::handle:vertical:hover {{
                    background-color: {color_scheme.get('hover', border_color)};
                }}

                QComboBox {{
                    background-color: {color_scheme.get('input_background', bg_color)};
                    color: {color_scheme.get('foreground', '#000000')};
                    border: 1px solid {border_color};
                    border-radius: 3px;
                    padding: 4px;
                }}
                """
                stylesheet_parts.append(control_style)

            # ÁîüÊàê„Åï„Çå„Åü„Çπ„Çø„Ç§„É´„Ç∑„Éº„Éà„ÇíÁµêÂêà„Åó„Å¶ÈÅ©Áî®
            if stylesheet_parts:
                combined_stylesheet = "\\n".join(stylesheet_parts)
                self.logger_system.info(f"Generated stylesheet length: {len(combined_stylesheet)} characters")

                # „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöÁîüÊàê„Åï„Çå„Åü„Çπ„Çø„Ç§„É´„Ç∑„Éº„Éà„Çí„É≠„Ç∞„Å´Âá∫Âäõ
                self.logger_system.debug(f"Generated stylesheet:\\n{combined_stylesheet[:500]}...")

                success = self._apply_style_sheet(combined_stylesheet)
                if success:
                    self.logger_system.info("Color scheme applied successfully")
                else:
                    self.logger_system.error("Failed to apply generated stylesheet")
                return success
            else:
                self.logger_system.warning("No stylesheet parts generated from color scheme")
                return False

        except Exception as e:
            self.logger_system.error(f"Failed to apply color scheme: {e}")
            import traceback
            self.logger_system.error(f"Traceback: {traceback.format_exc()}")
            return False

    def _get_default_color_scheme(self) -> Dict[str, str]:
        """„Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç´„É©„Éº„Çπ„Ç≠„Éº„É†„ÇíÂèñÂæó"""
        return {
            'background': '#ffffff',
            'foreground': '#000000',
            'primary': '#0078d4',
            'secondary': '#6c757d',
            'accent': '#17a2b8',
            'success': '#28a745',
            'warning': '#ffc107',
            'error': '#dc3545',
            'border': '#dee2e6',
            'hover': '#e3f2fd',
            'selected': '#0d7377',
            'disabled': '#6c757d',
            'input_background': '#ffffff',
            'button_text': '#ffffff'
        }

    def _darken_color(self, color: str, factor: float = 0.1) -> str:
        """Ëâ≤„ÇíÊöó„Åè„Åô„Çã"""
        try:
            # Á∞°Âçò„Å™Ëâ≤„ÅÆÊöóÂåñÂá¶ÁêÜ
            if color.startswith('#') and len(color) == 7:
                r = int(color[1:3], 16)
                g = int(color[3:5], 16)
                b = int(color[5:7], 16)

                r = max(0, int(r * (1 - factor)))
                g = max(0, int(g * (1 - factor)))
                b = max(0, int(b * (1 - factor)))

                return f"#{r:02x}{g:02x}{b:02x}"
            else:
                return color
        except Exception:
            return color'''

    if old_apply_color_scheme in content:
        content = content.replace(old_apply_color_scheme, new_apply_color_scheme)
        print("‚úÖ _apply_color_scheme „É°„ÇΩ„ÉÉ„Éâ„ÇíÊîπÂñÑ„Åó„Åæ„Åó„Åü")
    else:
        print("‚ö†Ô∏è  _apply_color_scheme „É°„ÇΩ„ÉÉ„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü")

    # 2. _apply_qt_theme „É°„ÇΩ„ÉÉ„Éâ„ÅÆÊîπÂñÑ
    old_apply_qt_theme = '''    def _apply_qt_theme(self, theme: ThemeConfiguration) -> bool:
        """Apply Qt theme (CursorBLD integration)"""
        try:
            success = True

            # 1. Qt-Theme-Manager„ÅÆ„ÉÜ„Éº„Éû„ÇíÈÅ©Áî®
            if self.qt_theme_manager and theme.qt_theme_name:
                if hasattr(self.qt_theme_manager, 'set_theme'):
                    success = self.qt_theme_manager.set_theme(theme.qt_theme_name)
                    if not success:
                        self.logger_system.warning(f"Failed to apply Qt theme: {theme.qt_theme_name}")
                else:
                    self.logger_system.warning("Qt-Theme-Manager set_theme method not found")

            # 2. „Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´„Ç∑„Éº„Éà„ÇíÈÅ©Áî®
            if theme.style_sheet:
                success = self._apply_style_sheet(theme.style_sheet) and success

            # 3. „Ç´„É©„Éº„Çπ„Ç≠„Éº„É†„ÇíÈÅ©Áî®
            if theme.color_scheme:
                success = self._apply_color_scheme(theme.color_scheme) and success

            return success

        except Exception as e:
            self.logger_system.warning(f"Failed to apply Qt theme: {e}")
            return False'''

    new_apply_qt_theme = '''    def _apply_qt_theme(self, theme: ThemeConfiguration) -> bool:
        """Apply Qt theme (CursorBLD integration) - ÊîπÂñÑÁâà"""
        try:
            self.logger_system.info(f"Applying Qt theme: {theme.name}")
            success = True

            # 1. Qt-Theme-Manager„ÅÆ„ÉÜ„Éº„Éû„ÇíÈÅ©Áî®
            if self.qt_theme_manager and hasattr(theme, 'qt_theme_name') and theme.qt_theme_name:
                if hasattr(self.qt_theme_manager, 'set_theme'):
                    qt_success = self.qt_theme_manager.set_theme(theme.qt_theme_name)
                    if qt_success:
                        self.logger_system.info(f"Qt-Theme-Manager theme applied: {theme.qt_theme_name}")
                    else:
                        self.logger_system.warning(f"Failed to apply Qt theme: {theme.qt_theme_name}")
                    success = qt_success and success
                else:
                    self.logger_system.warning("Qt-Theme-Manager set_theme method not found")
            else:
                self.logger_system.info("Qt-Theme-Manager not available or no qt_theme_name specified")

            # 2. „Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´„Ç∑„Éº„Éà„ÇíÈÅ©Áî®
            if hasattr(theme, 'style_sheet') and theme.style_sheet:
                self.logger_system.info(f"Applying custom stylesheet: {len(theme.style_sheet)} characters")
                style_success = self._apply_style_sheet(theme.style_sheet)
                success = style_success and success
            else:
                self.logger_system.info("No custom stylesheet provided")

            # 3. „Ç´„É©„Éº„Çπ„Ç≠„Éº„É†„ÇíÈÅ©Áî®ÔºàÊúÄ„ÇÇÈáçË¶ÅÔºâ
            if hasattr(theme, 'color_scheme') and theme.color_scheme:
                self.logger_system.info(f"Applying color scheme: {list(theme.color_scheme.keys())}")
                color_success = self._apply_color_scheme(theme.color_scheme)
                success = color_success and success
            else:
                self.logger_system.warning("No color scheme provided, generating from theme name")
                # „ÉÜ„Éº„ÉûÂêç„Åã„Çâ„Ç´„É©„Éº„Çπ„Ç≠„Éº„É†„ÇíÁîüÊàê
                generated_scheme = self._generate_color_scheme_from_theme_name(theme.name)
                color_success = self._apply_color_scheme(generated_scheme)
                success = color_success and success

            if success:
                self.logger_system.info(f"Qt theme applied successfully: {theme.name}")
            else:
                self.logger_system.error(f"Failed to apply Qt theme: {theme.name}")

            return success

        except Exception as e:
            self.logger_system.error(f"Failed to apply Qt theme: {e}")
            import traceback
            self.logger_system.error(f"Traceback: {traceback.format_exc()}")
            return False

    def _generate_color_scheme_from_theme_name(self, theme_name: str) -> Dict[str, str]:
        """„ÉÜ„Éº„ÉûÂêç„Åã„Çâ„Ç´„É©„Éº„Çπ„Ç≠„Éº„É†„ÇíÁîüÊàê"""
        try:
            # „ÉÄ„Éº„ÇØ„ÉÜ„Éº„Éû„ÅÆÂà§ÂÆö
            is_dark = any(keyword in theme_name.lower() for keyword in ['dark', 'night', 'black'])

            if is_dark:
                return {
                    'background': '#2b2b2b',
                    'foreground': '#ffffff',
                    'primary': '#007acc',
                    'secondary': '#6c757d',
                    'accent': '#17a2b8',
                    'success': '#28a745',
                    'warning': '#ffc107',
                    'error': '#dc3545',
                    'border': '#495057',
                    'hover': '#3a3a3a',
                    'selected': '#0d7377',
                    'disabled': '#6c757d',
                    'input_background': '#3a3a3a',
                    'button_text': '#ffffff'
                }
            else:
                return {
                    'background': '#ffffff',
                    'foreground': '#000000',
                    'primary': '#007acc',
                    'secondary': '#6c757d',
                    'accent': '#17a2b8',
                    'success': '#28a745',
                    'warning': '#ffc107',
                    'error': '#dc3545',
                    'border': '#dee2e6',
                    'hover': '#f8f9fa',
                    'selected': '#e3f2fd',
                    'disabled': '#6c757d',
                    'input_background': '#ffffff',
                    'button_text': '#ffffff'
                }
        except Exception as e:
            self.logger_system.error(f"Failed to generate color scheme: {e}")
            return self._get_default_color_scheme()'''

    if old_apply_qt_theme in content:
        content = content.replace(old_apply_qt_theme, new_apply_qt_theme)
        print("‚úÖ _apply_qt_theme „É°„ÇΩ„ÉÉ„Éâ„ÇíÊîπÂñÑ„Åó„Åæ„Åó„Åü")
    else:
        print("‚ö†Ô∏è  _apply_qt_theme „É°„ÇΩ„ÉÉ„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü")

    # 3. apply_theme „É°„ÇΩ„ÉÉ„Éâ„ÅÆÊîπÂñÑ
    old_apply_theme = '''    def apply_theme(self, theme_name: str) -> bool:
        """Apply the specified theme to the application"""

        try:
            if theme_name not in self.themes:
                self.theme_error.emit(theme_name, f"Theme '{theme_name}' not found")
                return False

            theme = self.themes[theme_name]

            # Apply Qt theme (CursorBLD integration)
            success = self._apply_qt_theme(theme)

            if success:
                # Apply accessibility features (Kiro enhancement)
                self._apply_accessibility_features(theme)

                # Apply performance settings (Kiro enhancement)
                self._apply_performance_settings(theme)

                # Update current theme
                self.current_theme = theme_name

                # Update configuration
                self.config_manager.set_setting("ui.theme", theme_name)

                # Update state
                self.state_manager.update_state(current_theme=theme_name)

                # Emit signals
                self.theme_changed.emit(theme_name)
                # Emit compatibility signal for SimpleThemeManager
                self.theme_changed_compat.emit(self.current_theme, theme_name)

                self.logger_system.log_ai_operation(
                    AIComponent.CURSOR, "theme_apply", f"Theme applied: {theme_name}"
                )

                return True
            else:
                self.theme_error.emit(theme_name, "Failed to apply Qt theme")
                return False

        except Exception as e:
            self.error_handler.handle_error(
                e,
                ErrorCategory.UI_ERROR,
                {"operation": "theme_apply", "theme": theme_name},
                AIComponent.CURSOR,
            )
            return False'''

    new_apply_theme = '''    def apply_theme(self, theme_name: str) -> bool:
        """Apply the specified theme to the application - ÊîπÂñÑÁâà"""

        try:
            self.logger_system.info(f"Starting theme application: {theme_name}")

            if theme_name not in self.themes:
                self.logger_system.error(f"Theme '{theme_name}' not found in available themes: {list(self.themes.keys())}")
                self.theme_error.emit(theme_name, f"Theme '{theme_name}' not found")
                return False

            theme = self.themes[theme_name]
            self.logger_system.info(f"Found theme configuration: {theme.name} - {theme.display_name}")

            # Apply Qt theme (CursorBLD integration)
            success = self._apply_qt_theme(theme)

            if success:
                self.logger_system.info("Qt theme applied successfully, applying additional features...")

                # Apply accessibility features (Kiro enhancement)
                try:
                    self._apply_accessibility_features(theme)
                    self.logger_system.info("Accessibility features applied")
                except Exception as e:
                    self.logger_system.warning(f"Failed to apply accessibility features: {e}")

                # Apply performance settings (Kiro enhancement)
                try:
                    self._apply_performance_settings(theme)
                    self.logger_system.info("Performance settings applied")
                except Exception as e:
                    self.logger_system.warning(f"Failed to apply performance settings: {e}")

                # Update current theme
                old_theme = self.current_theme
                self.current_theme = theme_name

                # Update configuration
                try:
                    self.config_manager.set_setting("ui.theme", theme_name)
                    self.logger_system.info("Theme configuration saved")
                except Exception as e:
                    self.logger_system.warning(f"Failed to save theme configuration: {e}")

                # Update state
                try:
                    self.state_manager.update_state(current_theme=theme_name)
                    self.logger_system.info("Theme state updated")
                except Exception as e:
                    self.logger_system.warning(f"Failed to update theme state: {e}")

                # Emit signals
                try:
                    self.theme_changed.emit(theme_name)
                    # Emit compatibility signal for SimpleThemeManager
                    self.theme_changed_compat.emit(old_theme, theme_name)
                    self.theme_applied.emit(theme_name)
                    self.logger_system.info("Theme change signals emitted")
                except Exception as e:
                    self.logger_system.warning(f"Failed to emit theme signals: {e}")

                self.logger_system.log_ai_operation(
                    AIComponent.CURSOR, "theme_apply", f"Theme applied successfully: {theme_name}"
                )

                self.logger_system.info(f"Theme application completed successfully: {theme_name}")
                return True
            else:
                self.logger_system.error(f"Failed to apply Qt theme: {theme_name}")
                self.theme_error.emit(theme_name, "Failed to apply Qt theme")
                return False

        except Exception as e:
            self.logger_system.error(f"Exception during theme application: {e}")
            import traceback
            self.logger_system.error(f"Traceback: {traceback.format_exc()}")

            self.error_handler.handle_error(
                e,
                ErrorCategory.UI_ERROR,
                {"operation": "theme_apply", "theme": theme_name},
                AIComponent.CURSOR,
            )
            return False'''

    if old_apply_theme in content:
        content = content.replace(old_apply_theme, new_apply_theme)
        print("‚úÖ apply_theme „É°„ÇΩ„ÉÉ„Éâ„ÇíÊîπÂñÑ„Åó„Åæ„Åó„Åü")
    else:
        print("‚ö†Ô∏è  apply_theme „É°„ÇΩ„ÉÉ„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü")

    # „Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò
    with open(theme_manager_path, 'w', encoding='utf-8') as f:
        f.write(content)

    print(f"‚úÖ „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆ‰øÆÊ≠£„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü: {theme_manager_path}")
    return True

def create_theme_debug_tool():
    """„ÉÜ„Éº„Éû„Éá„Éê„ÉÉ„Ç∞„ÉÑ„Éº„É´„Çí‰ΩúÊàê"""

    debug_tool_path = Path("debug_theme_stylesheet.py")

    debug_tool_content = '''#!/usr/bin/env python3
"""
„ÉÜ„Éº„Éû„Çπ„Çø„Ç§„É´„Ç∑„Éº„Éà„Éá„Éê„ÉÉ„Ç∞„ÉÑ„Éº„É´

„ÉÜ„Éº„ÉûË®≠ÂÆöÊôÇ„ÅÆ„Çπ„Çø„Ç§„É´„Ç∑„Éº„ÉàÁîüÊàê„Çí„Éá„Éê„ÉÉ„Ç∞„Åô„Çã„Åü„ÇÅ„ÅÆ„ÉÑ„Éº„É´„Åß„Åô„ÄÇ
- ÁèæÂú®„ÅÆ„ÉÜ„Éº„ÉûÁä∂ÊÖã„ÅÆÁ¢∫Ë™ç
- „Çπ„Çø„Ç§„É´„Ç∑„Éº„ÉàÁîüÊàê„ÅÆ„ÉÜ„Çπ„Éà
- „ÉÜ„Éº„ÉûÈÅ©Áî®„ÅÆÊ§úË®º

Author: Kiro AI Integration System
"""

import sys
import logging
from pathlib import Path

# „Éó„É≠„Ç∏„Çß„ÇØ„Éà„É´„Éº„Éà„Çí„Éë„Çπ„Å´ËøΩÂä†
sys.path.insert(0, str(Path(__file__).parent))

try:
    from PySide6.QtWidgets import QApplication, QMainWindow, QVBoxLayout, QWidget, QPushButton, QLabel, QTextEdit
    from PySide6.QtCore import Qt

    # „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„Çí„Ç§„É≥„Éù„Éº„Éà
    from src.integration.ui.theme_manager import IntegratedThemeManager
    from src.integration.config_manager import ConfigManager
    from src.integration.state_manager import StateManager
    from src.integration.logging_system import LoggerSystem

except ImportError as e:
    print(f"‚ùå ÂøÖË¶Å„Å™„É¢„Ç∏„É•„Éº„É´„ÅÆ„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: {e}")
    print("PySide6„Å®„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ")
    sys.exit(1)

class ThemeDebugWindow(QMainWindow):
    """„ÉÜ„Éº„Éû„Éá„Éê„ÉÉ„Ç∞„Ç¶„Ç£„É≥„Éâ„Ç¶"""

    def __init__(self):
        super().__init__()
        self.setWindowTitle("„ÉÜ„Éº„Éû„Çπ„Çø„Ç§„É´„Ç∑„Éº„Éà„Éá„Éê„ÉÉ„Ç∞„ÉÑ„Éº„É´")
        self.setGeometry(100, 100, 800, 600)

        # „É≠„Ç¨„Éº„ÅÆË®≠ÂÆö
        self.logger = LoggerSystem()
        self.logger.setup_logging(log_level=logging.DEBUG)

        # „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆÂàùÊúüÂåñ
        try:
            config_manager = ConfigManager()
            state_manager = StateManager(config_manager)

            self.theme_manager = IntegratedThemeManager(
                config_manager=config_manager,
                state_manager=state_manager,
                logger_system=self.logger,
                main_window=self
            )

            self.logger.info("„ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„ÅåÊ≠£Â∏∏„Å´ÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü")

        except Exception as e:
            self.logger.error(f"„ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó: {e}")
            self.theme_manager = None

        self.setup_ui()

    def setup_ui(self):
        """UI„ÅÆË®≠ÂÆö"""
        central_widget = QWidget()
        self.setCentralWidget(central_widget)

        layout = QVBoxLayout(central_widget)

        # „Çø„Ç§„Éà„É´
        title = QLabel("„ÉÜ„Éº„Éû„Çπ„Çø„Ç§„É´„Ç∑„Éº„Éà„Éá„Éê„ÉÉ„Ç∞„ÉÑ„Éº„É´")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        title.setStyleSheet("font-size: 18px; font-weight: bold; margin: 10px;")
        layout.addWidget(title)

        # ÁèæÂú®„ÅÆ„ÉÜ„Éº„ÉûË°®Á§∫
        self.current_theme_label = QLabel("ÁèæÂú®„ÅÆ„ÉÜ„Éº„Éû: Ë™≠„ÅøËæº„Åø‰∏≠...")
        layout.addWidget(self.current_theme_label)

        # „ÉÜ„Éº„Éû‰∏ÄË¶ßË°®Á§∫
        self.theme_list_label = QLabel("Âà©Áî®ÂèØËÉΩ„Å™„ÉÜ„Éº„Éû: Ë™≠„ÅøËæº„Åø‰∏≠...")
        layout.addWidget(self.theme_list_label)

        # „ÉÜ„Éº„ÉûÈÅ©Áî®„Éú„Çø„É≥
        button_layout = QVBoxLayout()

        self.test_light_button = QPushButton("„É©„Ç§„Éà„ÉÜ„Éº„Éû„Çí„ÉÜ„Çπ„Éà")
        self.test_light_button.clicked.connect(lambda: self.test_theme("default"))
        button_layout.addWidget(self.test_light_button)

        self.test_dark_button = QPushButton("„ÉÄ„Éº„ÇØ„ÉÜ„Éº„Éû„Çí„ÉÜ„Çπ„Éà")
        self.test_dark_button.clicked.connect(lambda: self.test_theme("dark"))
        button_layout.addWidget(self.test_dark_button)

        self.debug_button = QPushButton("„ÉÜ„Éº„ÉûÁä∂ÊÖã„Çí„Éá„Éê„ÉÉ„Ç∞")
        self.debug_button.clicked.connect(self.debug_theme_status)
        button_layout.addWidget(self.debug_button)

        layout.addLayout(button_layout)

        # „É≠„Ç∞Ë°®Á§∫„Ç®„É™„Ç¢
        self.log_display = QTextEdit()
        self.log_display.setMaximumHeight(200)
        self.log_display.setStyleSheet("font-family: monospace; font-size: 10px;")
        layout.addWidget(self.log_display)

        # ÂàùÊúüÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
        self.update_status()

    def update_status(self):
        """Áä∂ÊÖã„ÅÆÊõ¥Êñ∞"""
        if self.theme_manager:
            try:
                current_theme = self.theme_manager.get_current_theme()
                self.current_theme_label.setText(f"ÁèæÂú®„ÅÆ„ÉÜ„Éº„Éû: {current_theme}")

                available_themes = self.theme_manager.get_available_themes()
                self.theme_list_label.setText(f"Âà©Áî®ÂèØËÉΩ„Å™„ÉÜ„Éº„Éû ({len(available_themes)}): {', '.join(available_themes)}")

                self.log_display.append(f"‚úÖ „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„ÉºÁä∂ÊÖãÊõ¥Êñ∞ÂÆå‰∫Ü")

            except Exception as e:
                self.log_display.append(f"‚ùå Áä∂ÊÖãÊõ¥Êñ∞„Ç®„É©„Éº: {e}")
        else:
            self.current_theme_label.setText("ÁèæÂú®„ÅÆ„ÉÜ„Éº„Éû: „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„ÉºÊú™ÂàùÊúüÂåñ")
            self.theme_list_label.setText("Âà©Áî®ÂèØËÉΩ„Å™„ÉÜ„Éº„Éû: „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„ÉºÊú™ÂàùÊúüÂåñ")

    def test_theme(self, theme_name: str):
        """„ÉÜ„Éº„Éû„ÅÆ„ÉÜ„Çπ„Éà"""
        if not self.theme_manager:
            self.log_display.append("‚ùå „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì")
            return

        try:
            self.log_display.append(f"üîÑ „ÉÜ„Éº„Éû '{theme_name}' „ÇíÈÅ©Áî®‰∏≠...")

            success = self.theme_manager.apply_theme(theme_name)

            if success:
                self.log_display.append(f"‚úÖ „ÉÜ„Éº„Éû '{theme_name}' „ÅÆÈÅ©Áî®„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü")
                self.update_status()
            else:
                self.log_display.append(f"‚ùå „ÉÜ„Éº„Éû '{theme_name}' „ÅÆÈÅ©Áî®„Å´Â§±Êïó„Åó„Åæ„Åó„Åü")

        except Exception as e:
            self.log_display.append(f"‚ùå „ÉÜ„Éº„ÉûÈÅ©Áî®‰∏≠„Å´„Ç®„É©„Éº: {e}")

    def debug_theme_status(self):
        """„ÉÜ„Éº„ÉûÁä∂ÊÖã„ÅÆ„Éá„Éê„ÉÉ„Ç∞"""
        if not self.theme_manager:
            self.log_display.append("‚ùå „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì")
            return

        try:
            self.log_display.append("üîç „ÉÜ„Éº„ÉûÁä∂ÊÖã„Çí„Éá„Éê„ÉÉ„Ç∞‰∏≠...")

            # „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆ„Éá„Éê„ÉÉ„Ç∞„É°„ÇΩ„ÉÉ„Éâ„ÇíÂëº„Å≥Âá∫„Åó
            self.theme_manager.debug_theme_status()

            self.log_display.append("‚úÖ „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Çí„É≠„Ç∞„Å´Âá∫Âäõ„Åó„Åæ„Åó„Åü")

        except Exception as e:
            self.log_display.append(f"‚ùå „Éá„Éê„ÉÉ„Ç∞‰∏≠„Å´„Ç®„É©„Éº: {e}")

def main():
    """„É°„Ç§„É≥Èñ¢Êï∞"""
    app = QApplication(sys.argv)

    # „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÂü∫Êú¨Ë®≠ÂÆö
    app.setApplicationName("„ÉÜ„Éº„Éû„Éá„Éê„ÉÉ„Ç∞„ÉÑ„Éº„É´")
    app.setApplicationVersion("1.0.0")

    # „Éá„Éê„ÉÉ„Ç∞„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅÆ‰ΩúÊàê„Å®Ë°®Á§∫
    window = ThemeDebugWindow()
    window.show()

    # „Ç§„Éô„É≥„Éà„É´„Éº„Éó„ÅÆÈñãÂßã
    sys.exit(app.exec())

if __name__ == "__main__":
    main()
'''

    with open(debug_tool_path, 'w', encoding='utf-8') as f:
        f.write(debug_tool_content)

    print(f"‚úÖ „ÉÜ„Éº„Éû„Éá„Éê„ÉÉ„Ç∞„ÉÑ„Éº„É´„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü: {debug_tool_path}")
    return True

def main():
    """„É°„Ç§„É≥ÂÆüË°åÈñ¢Êï∞"""
    print("üîß „ÉÜ„Éº„Éû„Çπ„Çø„Ç§„É´„Ç∑„Éº„ÉàÁîüÊàê„ÅÆ‰øÆÊ≠£„ÇíÈñãÂßã„Åó„Åæ„Åô...")

    try:
        # 1. „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆ„Çπ„Çø„Ç§„É´„Ç∑„Éº„ÉàÁîüÊàê„Çí‰øÆÊ≠£
        if fix_theme_manager_stylesheet_generation():
            print("‚úÖ „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆ‰øÆÊ≠£„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü")
        else:
            print("‚ùå „ÉÜ„Éº„Éû„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆ‰øÆÊ≠£„Å´Â§±Êïó„Åó„Åæ„Åó„Åü")
            return False

        # 2. „Éá„Éê„ÉÉ„Ç∞„ÉÑ„Éº„É´„ÅÆ‰ΩúÊàê
        if create_theme_debug_tool():
            print("‚úÖ „Éá„Éê„ÉÉ„Ç∞„ÉÑ„Éº„É´„ÅÆ‰ΩúÊàê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü")
        else:
            print("‚ùå „Éá„Éê„ÉÉ„Ç∞„ÉÑ„Éº„É´„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü")

        print("\nüéâ „ÉÜ„Éº„Éû„Çπ„Çø„Ç§„É´„Ç∑„Éº„ÉàÁîüÊàê„ÅÆ‰øÆÊ≠£„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ")
        print("\nüìã ‰øÆÊ≠£ÂÜÖÂÆπ:")
        print("  - „Çπ„Çø„Ç§„É´„Ç∑„Éº„ÉàÁîüÊàê„É≠„Ç∏„ÉÉ„ÇØ„ÅÆÊîπÂñÑ")
        print("  - „Ç´„É©„Éº„Çπ„Ç≠„Éº„É†ÈÅ©Áî®„ÅÆÁ¢∫ÂÆüÊÄßÂêë‰∏ä")
        print("  - „Éá„Éê„ÉÉ„Ç∞Ê©üËÉΩ„ÅÆËøΩÂä†")
        print("  - „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÅÆÂº∑Âåñ")

        print("\nüîç „ÉÜ„Çπ„ÉàÊñπÊ≥ï:")
        print("  1. python debug_theme_stylesheet.py „Åß„Éá„Éê„ÉÉ„Ç∞„ÉÑ„Éº„É´„ÇíËµ∑Âãï")
        print("  2. ÂêÑ„ÉÜ„Éº„Éû„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÉÜ„Éº„ÉûÂ§âÊõ¥„Çí„ÉÜ„Çπ„Éà")
        print("  3. „É≠„Ç∞„Åß„Çπ„Çø„Ç§„É´„Ç∑„Éº„ÉàÁîüÊàêÁä∂Ê≥Å„ÇíÁ¢∫Ë™ç")

        return True

    except Exception as e:
        print(f"‚ùå ‰øÆÊ≠£‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: {e}")
        import traceback
        print(f"Ë©≥Á¥∞: {traceback.format_exc()}")
        return False

if __name__ == "__main__":
    main()
